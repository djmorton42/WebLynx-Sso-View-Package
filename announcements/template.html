<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" type="image/png" href="/views/announcements/sso-logo.png">
    <link rel="stylesheet" href="/views/announcements/styles.css">
  </head>
  <body>
    <div class="announcement-overlay">
      <!-- Header Section -->
      <div class="header-section">
        <div class="meet-info">
          <div class="meet-title" id="meet-title">{{MEET_TITLE}}</div>
          <div class="event-subtitle" id="event-subtitle">{{EVENT_SUBTITLE}}</div>
        </div>
        <div class="sso-logo">
          <img src="/views/announcements/sso-logo.png" alt="SSO Logo" />
        </div>
      </div>
      
      <!-- Main Content Area -->
      <div class="announcement-content">
        <div class="announcement-message" id="announcement-message" style="display: none;">
          <div class="loading">Loading announcement...</div>
        </div>
      </div>
      
      <!-- Sponsors Banner -->
      <div class="sponsors-banner">
        <div class="sponsors-left">
          <div class="sponsors-text">Thank you to our partners</div>
          <div class="sponsors-logos">
            <img src="/views/announcements/sponsors/cao.avif" alt="CAO" class="sponsor-logo" />
            <img src="/views/announcements/sponsors/csi.avif" alt="CSI" class="sponsor-logo" />
            <img src="/views/announcements/sponsors/nagano.avif" alt="Nagano" class="sponsor-logo" />
            <img src="/views/announcements/sponsors/ontario.avif" alt="Ontario" class="sponsor-logo" />
          </div>
        </div>
        <div class="sponsors-right">
          <div class="sponsor-title"></div>
          <div class="sponsor-slides"></div>
        </div>
      </div>
    </div>
    
    <script src="/views/shared/weblynx-helpers.js"></script>
    <script>
      // Configuration
      const UPDATE_INTERVAL = 2000; // milliseconds
      
      function updateAnnouncementData() {
        WebLynx.updateRaceData((data, error) => {
          if (error) {
            console.error('Error fetching race data:', error);
            const announcementElement = document.getElementById('announcement-message');
            announcementElement.style.display = 'none';
            return;
          }
          
          // Update announcement message
          const announcementElement = document.getElementById('announcement-message');
          
          if (data.announcementMessage && data.announcementMessage.trim()) {
            announcementElement.innerHTML = data.announcementMessage;
            announcementElement.className = 'announcement-message';
            announcementElement.style.display = 'block';
          } else {
            announcementElement.style.display = 'none';
          }
        });
      }
      
      // Start updating
      WebLynx.startAutoUpdate(updateAnnouncementData, UPDATE_INTERVAL);
      
      // Load sponsor data from JSON file
      async function loadSponsorData() {
        const sponsorJsonPath = '/views/announcements/sponsors/sponsor-text.json';
        const sponsorsRight = document.querySelector('.sponsors-right');
        const sponsorsBanner = document.querySelector('.sponsors-banner');
        const sponsorsLeft = document.querySelector('.sponsors-left');
        const sponsorTitle = document.querySelector('.sponsor-title');
        const sponsorSlides = document.querySelector('.sponsor-slides');
        
        try {
          const response = await fetch(sponsorJsonPath);
          if (!response.ok) {
            throw new Error('File not found');
          }
          
          const data = await response.json();
          
          // Validate JSON structure
          if (!data.title || !data.slides || !Array.isArray(data.slides)) {
            throw new Error('Invalid JSON structure');
          }
          
          // Set the title
          if (sponsorTitle) {
            sponsorTitle.textContent = data.title;
          }
          
          // Build slides dynamically
          if (sponsorSlides) {
            sponsorSlides.innerHTML = '';
            data.slides.forEach((slide, index) => {
              if (!slide.sponsors || !Array.isArray(slide.sponsors)) {
                return; // Skip invalid slides
              }
              
              const slideDiv = document.createElement('div');
              slideDiv.className = 'sponsor-slide';
              if (index === 0) {
                slideDiv.classList.add('active');
              }
              slideDiv.setAttribute('data-slide', index);
              
              // Add each sponsor as a separate div
              slide.sponsors.forEach(sponsor => {
                const sponsorDiv = document.createElement('div');
                sponsorDiv.className = 'sponsor-name';
                sponsorDiv.textContent = sponsor;
                slideDiv.appendChild(sponsorDiv);
              });
              
              sponsorSlides.appendChild(slideDiv);
            });
          }
          
          // Show right column and use two-column layout
          if (sponsorsRight) {
            sponsorsRight.style.display = 'block';
          }
          if (sponsorsBanner) {
            sponsorsBanner.classList.remove('single-column');
          }
          if (sponsorsLeft) {
            sponsorsLeft.classList.remove('full-width');
          }
          
          // Initialize slide rotation
          initializeSponsorSlides();
          
        } catch (error) {
          // File doesn't exist or error, hide right column
          console.log('Sponsor JSON file not found, using single column layout:', error);
          if (sponsorsRight) {
            sponsorsRight.style.display = 'none';
          }
          if (sponsorsBanner) {
            sponsorsBanner.classList.add('single-column');
          }
          if (sponsorsLeft) {
            sponsorsLeft.classList.add('full-width');
          }
        }
      }
      
      // Initialize sponsor slides rotation
      function initializeSponsorSlides() {
        let currentSlide = 0;
        const slides = document.querySelectorAll('.sponsor-slide');
        const totalSlides = slides.length;
        
        if (totalSlides === 0) {
          return; // No slides to rotate
        }
        
        function rotateSponsorSlides() {
          // Hide current slide
          slides[currentSlide].classList.remove('active');
          
          // Move to next slide
          currentSlide = (currentSlide + 1) % totalSlides;
          
          // Show next slide
          slides[currentSlide].classList.add('active');
        }
        
        // Start rotating slides every 5 seconds
        setInterval(rotateSponsorSlides, 5000);
      }
      
      // Load sponsor data on page load
      loadSponsorData();
    </script>
  </body>
</html>
